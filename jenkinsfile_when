pipeline {
    agent any

    environment {
      WEBSERVER = "Nginx"
    }
    stages {
        stage('Mostrar Información del Entorno') {
            steps {
                echo "=== Información del Entorno de Jenkins ==="
                
                // Mostrar variables de entorno de Jenkins
                sh 'echo "Jenkins Home: $JENKINS_HOME"'
                sh 'echo "Node Name: $NODE_NAME"'
                sh 'echo "Job Name: $JOB_NAME"'
                sh 'echo "Build Number: $BUILD_NUMBER"'

                // Usuario que ejecuta el proceso
                sh 'echo "Usuario del proceso: $(whoami)"'
                
                // Mostrar información del sistema operativo
                sh 'echo "Sistema Operativo:" && uname -a'
                
                // Mostrar directorio de trabajo
                sh 'echo "Directorio de trabajo:" && pwd'
                
                // Mostrar espacio en disco
                sh 'echo "Espacio en disco disponible:" && df -h'
                
                // Mostrar memoria
                sh 'echo "Memoria disponible:" && free -h'
                
                // Mostrar variables de entorno completas (opcional)
                sh 'echo "=== Todas las variables de entorno ===" && printenv'
            }
        }
        stage('Configure Docker remote context') {
            steps {
                echo 'Configuring Docker remote context...'
                sh '''
                  docker context inspect remoto >/dev/null 2>&1 || \
                  docker context create remoto --docker "host=ssh://pi@192.168.2.4"
                  docker context use remoto
                  docker context ls
                '''
            }
        }
        stage('Create web directory')
        {
            input {
              message 'Enter the data'
              parameters {
                    string(name:'AUTHOR', defaultValue: 'Sergio', description: 'Author of the web application deployment ')
                    string(name:'ENVIRONMENT', defaultValue: 'Development',description: 'Environment to deploy')
                 }
            }
            steps{
                echo "The responsible of this project is ${AUTHOR} and and will be deployed in ${ENVIRONMENT}" 
            }
        }
        stage('Drop the Apache Nginx Docker container'){
            steps {
            echo 'droping the container...'
            sh 'docker rm -f apache'
            sh 'docker rm -f nginx'
            }
        }
        stage('Create the Apache httpd container') {
            when {
              environment name: 'WEBSERVER', value: 'Apache'
              beforeAgent true
            }
            steps {
                echo 'Creating the container...'
                sh '''
                  docker run -dit \
                    --name apache \
                    -p 9001:80 \
                    -v $WORKSPACE/web:/usr/local/apache2/htdocs/ \
                    httpd
                '''
                }
        }
        stage('Create the Apache Nginx container') {
            when {
              environment name: 'WEBSERVER', value: 'Nginx'
              beforeAgent true
            }
            steps {
                echo 'Creating the container...'
                sh '''
                  docker run -dit \
                    --name nginx \
                    -p 9001:80 \
                    -v $WORKSPACE/web:/usr/share/nginx/html/ \
                    nginx
                '''
                }
        }
        stage('Copy web files into container Apache') {
            when {
              environment name: 'WEBSERVER', value: 'Apache'
              beforeAgent true
            }
            steps {
                sh 'docker cp $WORKSPACE/web/. apache:/usr/local/apache2/htdocs/'
            }
        }
        stage('Copy web files into container Nginx') {
            when {
              environment name: 'WEBSERVER', value: 'Nginx'
              beforeAgent true
            }
            steps {
                sh 'docker cp $WORKSPACE/web/. nginx:/usr/share/nginx/html/'
            }
        }
    }
    post {
          cleanup {
            // One or more steps need to be included within each condition's block.
              echo 'cleanup process'
          }
          success {
            // One or more steps need to be included within each condition's block.
              echo 'success process'
              archiveArtifacts allowEmptyArchive: true, artifacts: 'shopping/*.jsp', followSymlinks: false
              cleanWs()   
          }
          failure {
            // One or more steps need to be included within each condition's block.
              echo 'failure process'
          }
        }
}
